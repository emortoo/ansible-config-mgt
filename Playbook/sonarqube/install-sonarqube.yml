---
- name: Install SonarQube
  hosts: your_target_hosts
  become: true
  vars:
    sonarqube_version: "8.9.0.43852"
    sonarqube_download_url: "https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-{{ sonarqube_version }}.zip"
    sonarqube_install_directory: "/opt/sonarqube"
    sonarqube_user: "sonarqube"
    sonarqube_group: "sonarqube"

  tasks:
    - name: Create SonarQube User
      user:
        name: "{{ sonarqube_user }}"
        system: true
        shell: /bin/false

    - name: Create SonarQube Group
      group:
        name: "{{ sonarqube_group }}"
        system: true

    - name: Install Unzip (if not present)
      yum:
        name: unzip
        state: present

    - name: Download SonarQube
      get_url:
        url: "{{ sonarqube_download_url }}"
        dest: "/tmp/sonarqube.zip"
        mode: '0440'

    - name: Create SonarQube Installation Directory
      file:
        path: "{{ sonarqube_install_directory }}"
        state: directory
        owner: "{{ sonarqube_user }}"
        group: "{{ sonarqube_group }}"
        mode: '0755'

    - name: Unzip SonarQube to Installation Directory
      unarchive:
        src: "/tmp/sonarqube.zip"
        dest: "{{ sonarqube_install_directory }}"
        remote_src: yes
        extra_opts: [--strip-components=1]
        owner: "{{ sonarqube_user }}"
        group: "{{ sonarqube_group }}"

    - name: Set Permission for SonarQube Installation
      file:
        path: "{{ sonarqube_install_directory }}"
        owner: "{{ sonarqube_user }}"
        group: "{{ sonarqube_group }}"
        recurse: yes
        mode: '0755'

    - name: Create SonarQube Service File
      copy:
        content: |
          [Unit]
          Description=SonarQube service
          After=syslog.target network.target

          [Service]
          Type=simple
          User={{ sonarqube_user }}
          Group={{ sonarqube_group }}
          PermissionsStartOnly=true
          ExecStart={{ sonarqube_install_directory }}/bin/linux-x86-64/sonar.sh start
          ExecStop={{ sonarqube_install_directory }}/bin/linux-x86-64/sonar.sh stop
          Restart=always

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/sonarqube.service

    - name: Reload Systemd Daemon
      systemd:
        daemon_reload: yes

    - name: Enable and Start SonarQube Service
      systemd:
        name: sonarqube
        enabled: yes
        state: started
